Set-PSDebug -Trace 2

$ErrorActionPreference = "Stop";
trap { $host.SetShouldExit(1) }

$BOSH_INSTALL_TARGET = Resolve-Path "${env:BOSH_INSTALL_TARGET}"
$path=(Get-ChildItem "envoy-nginx/envoy-nginx*.zip").FullName
Expand-Archive -Path $path -DestinationPath ${BOSH_INSTALL_TARGET}

. C:\var\vcap\packages\golang-1.17-windows\bosh\compile.ps1
$env:GOPATH="${BOSH_INSTALL_TARGET}"
$env:PATH="${env:GOROOT}\bin;${env:PATH}"`

New-Item -ItemType "directory" -Force src

robocopy.exe /E "${PWD}" "src" /xd src
if ($LASTEXITCODE -ge 8) {
    Write-Error "robocopy.exe /E "${PWD}" "src" /xd src"
}

Push-Location code.cloudfoundry.org/envoy-nginx
go.exe build -v -mod vendor -o "${BOSH_INSTALL_TARGET}\envoy.exe"
if ($LASTEXITCODE -ne 0) {
    ls  C:\var\vcap\sys\log\compilation\
    Get-ChildItem -Path 'C:\var\vcap\sys\log\compilation\*.log' | ForEach-Object{
        Get-Content $_.FullName
    }
    Write-Error "Error compiling: code.cloudfoundry.org/envoy-nginx"
}
Pop-Location

Exit 0
